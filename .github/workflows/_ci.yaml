name: _ci (Reusable workflow)

on:
  workflow_call:
    inputs:
      os:
        description: String representing a JSON array of strings - monikers of GitHub runners. Cannot be null or empty!
        type: string
        default: >-
          ["ubuntu-latest"]

      dotnet-version:
        description: Version of .NET SDK to use. Cannot be null or empty!.
        type: string
        default: 10.0.x

      configuration:
        description: The type of build to produce, e.g. Release vs Debug. Cannot be null or empty!
        type: string
        default: Release

      preprocessor-symbols:
        description: Define preprocessor symbols to pass to the compiler
        type: string
        default: ""

      build-projects:
        description: JSON array as a string of paths to the projects or solutions to build. If not provided, null, or empty, the solution/project in the repository root will be built.
        type: string
        required: false

      test-projects:
        description: JSON array as a string of paths to the test projects to run. If not provided, null, or empty, tests will be skipped.
        type: string
        required: false

      benchmark-projects:
        description: JSON array as a string of paths to the benchmark projects to run. If not provided, null, or empty, benchmarks will be skipped.
        type: string
        required: false

      min-coverage-pct:
        description: Minimum acceptable code coverage percentage. Cannot be 0, null or empty!
        type: number
        default: 80 # percent

      max-regression-pct:
        description: Maximum acceptable performance regression percentage. Cannot be more than 50, null or empty!
        type: number
        default: 20 # percent

    secrets:
      CODECOV_TOKEN:
        description: Codecov API token for uploading coverage reports
        required: false
      BENCHER_API_TOKEN:
        description: Bencher.dev API token for benchmark tracking
        required: false

concurrency:
  group: ci-${{ github.workflow_ref }}
  cancel-in-progress: true

jobs:
  # Validate all input parameters and prepare them for downstream jobs
  setup:
    name: Parameters validation
    runs-on: ubuntu-latest
    outputs:
      build-projects: ${{ steps.setup.outputs.build-projects }}
      test-projects: ${{ steps.setup.outputs.test-projects }}
      benchmark-projects: ${{ steps.setup.outputs.benchmark-projects }}
      os: ${{ steps.setup.outputs.os }}
      dotnet-version: ${{ steps.setup.outputs.dotnet-version }}
      configuration: ${{ steps.setup.outputs.configuration }}
      preprocessor-symbols: ${{ steps.setup.outputs.preprocessor-symbols }}
      min-coverage-pct: ${{ steps.setup.outputs.min-coverage-pct }}
      max-regression-pct: ${{ steps.setup.outputs.max-regression-pct }}

    steps:
      # Clone the repository to access validation scripts
      - name: Checkout
        uses: actions/checkout@v6

      # Setup DevOps scripts (works for both local and external calls)
      - name: Checkout DevOps repository scripts
        if: github.repository != 'vmelamed/vm2.DevOps'
        uses: actions/checkout@v6
        with:
          repository: vmelamed/vm2.DevOps
          path: vm2-devops
          sparse-checkout: |
            .github/actions/scripts

      - name: Setup DevOps scripts (local)
        if: github.repository == 'vmelamed/vm2.DevOps'
        uses: ./.github/actions/scripts

      - name: Setup DevOps scripts (external)
        if: github.repository != 'vmelamed/vm2.DevOps'
        uses: ./vm2-devops/.github/actions/scripts

      # Run validation script to verify and normalize all input parameters
      - name: Run validation script to verify and normalize all input parameters
        id: setup
        shell: bash
        run: |
          validate-vars.sh \
              --build-projects       '${{ inputs.build-projects }}' \
              --test-projects        '${{ inputs.test-projects }}' \
              --benchmark-projects   '${{ inputs.benchmark-projects }}' \
              --os                   '${{ inputs.os }}' \
              --dotnet-version       '${{ inputs.dotnet-version }}' \
              --configuration        '${{ inputs.configuration }}' \
              --preprocessor-symbols '${{ inputs.preprocessor-symbols }}' \
              --min-coverage-pct     '${{ inputs.min-coverage-pct }}' \
              --max-regression-pct   '${{ inputs.max-regression-pct }}'

  # Build the project and cache artifacts for downstream test/benchmark jobs
  build:
    name: Build
    needs:
      - setup
    strategy:
      # fail-fast: true
      matrix:
        os: ${{ fromJSON(needs.setup.outputs.os) }}
        build-project: ${{ fromJSON(needs.setup.outputs.build-projects) }}
    uses: vmelamed/vm2.DevOps/.github/workflows/_build.yaml@main
    with:
      os: ${{ matrix.os }}
      dotnet-version: ${{ needs.setup.outputs.dotnet-version }}
      configuration: ${{ needs.setup.outputs.configuration }}
      preprocessor-symbols: ${{ needs.setup.outputs.preprocessor-symbols }}
      build-project: ${{ matrix.build-project }}

  # Run unit tests with code coverage analysis
  test:
    name: Tests
    needs:
      - setup
      - build
    strategy:
      # fail-fast: true
      matrix:
        os: ${{ fromJSON(needs.setup.outputs.os) }}
        test-project: ${{ fromJSON(needs.setup.outputs.test-projects) }}
    # __skip__ sentinel avoids empty-matrix expansion when no tests are requested
    if: needs.setup.outputs.test-projects != '["__skip__"]'
    uses: vmelamed/vm2.DevOps/.github/workflows/_test.yaml@main
    permissions:
      contents: read
      pull-requests: write # Required to comment on PRs
      checks: write # Required to create GitHub Checks
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
    with:
      os: ${{ matrix.os }}
      dotnet-version: ${{ needs.setup.outputs.dotnet-version }}
      configuration: ${{ needs.setup.outputs.configuration }}
      preprocessor-symbols: ${{ needs.setup.outputs.preprocessor-symbols }}
      test-project: ${{ matrix.test-project }}
      min-coverage-pct: ${{ fromJSON(needs.setup.outputs.min-coverage-pct) }}

  # Run performance benchmarks and compare against baseline (if enabled and benchmark project specified)
  benchmarks:
    name: Benchmarks
    needs:
      - setup
      - build
    strategy:
      # fail-fast: true
      matrix:
        os: ${{ fromJSON(needs.setup.outputs.os) }}
        benchmark-project: ${{ fromJSON(needs.setup.outputs.benchmark-projects) }}
    # __skip__ sentinel avoids empty-matrix expansion; still honor [skip bm] on pushes
    if: needs.setup.outputs.benchmark-projects != '["__skip__"]' && (github.event_name != 'push' || !contains(github.event.head_commit.message, '[skip bm]'))
    uses: vmelamed/vm2.DevOps/.github/workflows/_benchmarks.yaml@main
    permissions:
      contents: read
      pull-requests: write # Required to comment on PRs
      checks: write # Required to create GitHub Checks
    secrets:
      BENCHER_API_TOKEN: ${{ secrets.BENCHER_API_TOKEN }}
    with:
      os: ${{ matrix.os }}
      dotnet-version: ${{ needs.setup.outputs.dotnet-version }}
      configuration: ${{ needs.setup.outputs.configuration }}
      preprocessor-symbols: ${{ needs.setup.outputs.preprocessor-symbols }}
      benchmark-project: ${{ matrix.benchmark-project }}
      max-regression-pct: ${{ fromJSON(needs.setup.outputs.max-regression-pct) }}
