name: _ci (Reusable workflow)

on:
  workflow_call:
    inputs:
      build-project:
        description: Path to the project to build (if null, empty, ow whitespace, builds the solution or the project in the current directory).
        type: string
        required: false

      test-project:
        description: Path to the test project to run tests against (cannot be null or empty string)
        type: string
        required: true

      benchmark-project:
        description: Path to the benchmark project. If not provided, null, or empty, benchmarks will be skipped.
        type: string
        required: false

      os:
        description: Runner OS-s (cannot be null or empty string, default ubuntu-latest)
        type: string
        default: ubuntu-latest

      dotnet-version:
        description: Version of .NET SDK to use (cannot be null or empty string, default 10.0.x)
        type: string
        default: 10.0.x

      configuration:
        description: The type of build to produce, e.g. Release vs Debug (cannot be null or empty string, default Release)
        type: string
        default: Release

      preprocessor-symbols:
        description: Define preprocessor symbols to pass to the compiler
        type: string
        default: ""

      min-coverage-pct:
        description: Minimum acceptable code coverage percentage (cannot be 0, null or empty, default 80)
        type: number
        default: 80 # percent

      max-regression-pct:
        description: Maximum acceptable performance regression percentage
        type: number
        default: 10 # percent

      force-new-baseline:
        description: The benchmarks outputs become the new baseline (no regression check)
        type: boolean
        default: false

      cached-dependencies:
        description: Enable caching of NuGet dependencies (default true)
        type: boolean
        default: true

      cached-artifacts:
        description: Enable caching of build artifacts (default true)
        type: boolean
        default: true

      verbose:
        description: Enable verbose logging by the scripts for debugging purposes
        type: boolean
        default: false

concurrency:
  group: ci-${{ github.ref }}-${{ inputs.build-project }}-${{ inputs.test-project }}
  cancel-in-progress: true

jobs:
  # Validate all input parameters and prepare them for downstream jobs
  setup:
    name: Parameters validation
    runs-on: ${{ inputs.os }}
    if: >
      ${{
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip ci]')
      }}
    outputs:
      build-project:        ${{ steps.setup-vars.outputs.build-project }}
      test-project:         ${{ steps.setup-vars.outputs.test-project }}
      benchmark-project:    ${{ steps.setup-vars.outputs.benchmark-project }}
      os:                   ${{ steps.setup-vars.outputs.os }}
      dotnet-version:       ${{ steps.setup-vars.outputs.dotnet-version }}
      configuration:        ${{ steps.setup-vars.outputs.configuration }}
      preprocessor-symbols: ${{ steps.setup-vars.outputs.preprocessor-symbols }}
      min-coverage-pct:     ${{ steps.setup-vars.outputs.min-coverage-pct }}
      max-regression-pct:   ${{ steps.setup-vars.outputs.max-regression-pct }}
      force-new-baseline:   ${{ steps.setup-vars.outputs.force-new-baseline }}
      verbose:              ${{ steps.setup-vars.outputs.verbose }}
      cached-dependencies:  ${{ inputs.cached-dependencies }}
      cached-artifacts:     ${{ inputs.cached-artifacts }}

    steps:
      # Clone the repository to access validation scripts
      - name: Checkout
        uses: actions/checkout@v6

      # Make bash scripts executable on Unix-like systems
      - name: Make Scripts Executable
        run: chmod u+x ./scripts/bash/*.sh

      # Run validation script to verify and normalize all input parameters
      - id: setup-vars
        shell: bash
        run: |
          ./scripts/bash/setup-ci-vars.sh \
              --build-project        ${{ inputs.build-project }} \
              --test-project         ${{ inputs.test-project }} \
              --benchmark-project    ${{ inputs.benchmark-project }} \
              --os                   ${{ inputs.os }} \
              --dotnet-version       ${{ inputs.dotnet-version }} \
              --configuration        ${{ inputs.configuration }} \
              --preprocessor-symbols ${{ inputs.preprocessor-symbols }} \
              --min-coverage-pct     ${{ inputs.min-coverage-pct }} \
              --force-new-baseline   ${{ inputs.force-new-baseline }} \
              --max-regression-pct   ${{ inputs.max-regression-pct }} \
              --verbose              ${{ inputs.verbose }}

  # Build the project and cache artifacts for downstream test/benchmark jobs
  build_job:
    name: Build
    needs:
      - setup
    uses: ./.github/workflows/_build.yaml
    with:
      build-project:        ${{ needs.setup.outputs.build-project }}
      os:                   ${{ needs.setup.outputs.os }}
      dotnet-version:       ${{ needs.setup.outputs.dotnet-version }}
      configuration:        ${{ needs.setup.outputs.configuration }}
      preprocessor-symbols: ${{ needs.setup.outputs.preprocessor-symbols }}
      cached-dependencies:  ${{ fromJSON(needs.setup.outputs.cached-dependencies) }}
      cached-artifacts:     ${{ fromJSON(needs.setup.outputs.cached-artifacts) }}

  # Run unit tests with code coverage analysis
  test_job:
    name: Test
    needs:
      - setup
      - build_job
    uses: ./.github/workflows/_test.yaml
    with:
      test-project:         ${{ needs.setup.outputs.test-project }}
      os:                   ${{ needs.setup.outputs.os }}
      dotnet-version:       ${{ needs.setup.outputs.dotnet-version }}
      configuration:        ${{ needs.setup.outputs.configuration }}
      preprocessor-symbols: ${{ needs.setup.outputs.preprocessor-symbols }}
      min-coverage-pct:     ${{ fromJSON(needs.setup.outputs.min-coverage-pct) }}
      verbose:              ${{ fromJSON(needs.setup.outputs.verbose) }}
      cached-dependencies:  ${{ fromJSON(needs.setup.outputs.cached-dependencies) }}
      cached-artifacts:     ${{ fromJSON(needs.setup.outputs.cached-artifacts) }}

  # Run performance benchmarks and compare against baseline (if enabled and benchmark project specified)
  benchmarks_job:
    name: Benchmarks
    if: ${{ fromJSON(needs.setup.outputs.benchmark-project) != '' }}
    needs:
      - setup
      - build_job
    #uses: ./.github/workflows/_benchmarks.yaml
    #with:
    #  os:                   ${{ needs.setup.outputs.os }}
    #  dotnet-version:       ${{ needs.setup.outputs.dotnet-version }}
    #  configuration:        ${{ needs.setup.outputs.configuration }}
    #  preprocessor-symbols: ${{ needs.setup.outputs.preprocessor-symbols }}
    #  benchmark-project:    ${{ needs.setup.outputs.benchmark-project }}
    #  max-regression-pct:   ${{ fromJSON(needs.setup.outputs.max-regression-pct) }}
    #  force-new-baseline:   ${{ fromJSON(needs.setup.outputs.force-new-baseline) }}
    #  verbose:              ${{ fromJSON(needs.setup.outputs.verbose) }}
    #  cached-dependencies:  ${{ fromJSON(needs.setup.outputs.cached-dependencies) }}
    #  cached-artifacts:     ${{ fromJSON(needs.setup.outputs.cached-artifacts) }}
    runs-on: ${{ inputs.os }}
    steps:
      # Display all workflow inputs for debugging and verification
      - name: Print all inputs
        shell: bash
        run: |
          {
            echo "inputs.os:                   ${{ needs.setup.outputs.os }}"
            echo "inputs.dotnet-version:       ${{ needs.setup.outputs.dotnet-version }}"
            echo "inputs.configuration:        ${{ needs.setup.outputs.configuration }}"
            echo "inputs.preprocessor-symbols: ${{ needs.setup.outputs.preprocessor-symbols }}"
            echo "inputs.benchmark-project:    ${{ needs.setup.outputs.benchmark-project }}"
            echo "inputs.max-regression-pct:   ${{ fromJSON(needs.setup.outputs.max-regression-pct) }}"
            echo "inputs.force-new-baseline:   ${{ fromJSON(needs.setup.outputs.force-new-baseline) }}"
            echo "inputs.verbose:              ${{ fromJSON(needs.setup.outputs.verbose) }}"
            echo "inputs.cached-dependencies:  ${{ fromJSON(needs.setup.outputs.cached-dependencies) }}"
            echo "inputs.cached-artifacts:     ${{ fromJSON(needs.setup.outputs.cached-artifacts) }}"
          } >> $GITHUB_STEP_SUMMARY
