name: _ci (Reusable workflow)

on:
  workflow_call:
    inputs:
      build-projects:
        description: JSON array as a string of paths to the projects or solutions to build. If not provided, null, or empty, the solution/project in the repository root will be built.
        type: string
        required: false

      test-projects:
        description: JSON array as a string of paths to the test projects to run. If not provided, null, or empty, tests will be skipped.
        type: string
        required: false

      benchmark-projects:
        description: JSON array as a string of paths to the benchmark projects to run. If not provided, null, or empty, benchmarks will be skipped.
        type: string
        required: false

      runners-os:
        description: String containing a JSON array of strings - monikers of GitHub runners. Cannot be null or empty!
        type: string
        default: >-
          ["ubuntu-latest"]

      dotnet-version:
        description: Version of .NET SDK to use. Cannot be null or empty!.
        type: string
        default: 10.0.x

      configuration:
        description: The type of build to produce, e.g. Release vs Debug. Cannot be null or empty!
        type: string
        default: Release

      preprocessor-symbols:
        description: Define preprocessor symbols to pass to the compiler
        type: string
        default: ""

      min-coverage-pct:
        description: Minimum acceptable code coverage percentage. Cannot be 0, null or empty!
        type: number
        default: 80 # percent

      max-regression-pct:
        description: Maximum acceptable performance regression percentage. Cannot be more than 50, null or empty!
        type: number
        default: 20 # percent

      minver-tag-prefix:
        description: MinVer tag prefix to use for version calculation. Cannot be null or empty!
        type: string
        default: v

      minver-prerelease-id:
        description: MinVer default pre-release identifiers to use for version calculation. Cannot be null or empty!
        type: string
        default: preview

    secrets:
      CODECOV_TOKEN:
        description: Codecov API token for uploading coverage reports
        required: false

      BENCHER_API_TOKEN:
        description: Bencher.dev API token for benchmark tracking
        required: false

      REPORTGENERATOR_LICENSE:
        description: ReportGenerator license key for enhanced coverage reports
        required: false

env:
  VERBOSE: ${{ vars.VERBOSE }}

concurrency:
  group: ci-${{ github.workflow_ref }}
  cancel-in-progress: true

jobs:
  # Validate all input parameters and prepare them for downstream jobs
  validate-input:
    name: Parameters validation
    runs-on: ubuntu-latest
    outputs:
      build-projects: ${{ steps.validate.outputs.build-projects }}
      test-projects: ${{ steps.validate.outputs.test-projects }}
      benchmark-projects: ${{ steps.validate.outputs.benchmark-projects }}
      runners-os: ${{ steps.validate.outputs.runners-os }}
      dotnet-version: ${{ steps.validate.outputs.dotnet-version }}
      configuration: ${{ steps.validate.outputs.configuration }}
      preprocessor-symbols: ${{ steps.validate.outputs.preprocessor-symbols }}
      min-coverage-pct: ${{ steps.validate.outputs.min-coverage-pct }}
      max-regression-pct: ${{ steps.validate.outputs.max-regression-pct }}
      minver-tag-prefix: ${{ steps.validate.outputs.minver-tag-prefix }}
      minver-prerelease-id: ${{ steps.validate.outputs.minver-prerelease-id }}

    steps:
      # Clone the repository to access validation scripts
      - name: Checkout
        uses: actions/checkout@v6

      # Clone only the scripts from vm2.DevOps, so that we can run the composite
      # action .github/actions/scripts/action.yaml for both local and external calls
      - name: Checkout vm2.DevOps repository scripts
        if: github.repository != 'vmelamed/vm2.DevOps'
        uses: actions/checkout@v6
        with:
          repository: vmelamed/vm2.DevOps
          path: vm2-devops
          sparse-checkout: |+
            scripts/bash/lib
            .github/actions/scripts
      - name: Ensure the workflows can access scripts from within vm2.DevOps
        if: github.repository == 'vmelamed/vm2.DevOps'
        uses: ./.github/actions/scripts
      - name: Ensure the workflows can access scripts from outside vm2.DevOps
        if: github.repository != 'vmelamed/vm2.DevOps'
        uses: ./vm2-devops/.github/actions/scripts

      # Run validation script to verify and normalize all inputs (inputs, env, vars, secrets, etc.)
      - name: Validate and normalize all inputs
        id: validate
        shell: bash
        run: |
          validate-input.sh \
              --build-projects       '${{ inputs.build-projects }}' \
              --test-projects        '${{ inputs.test-projects }}' \
              --benchmark-projects   '${{ inputs.benchmark-projects }}' \
              --runners-os           '${{ inputs.runners-os }}' \
              --dotnet-version       '${{ inputs.dotnet-version }}' \
              --configuration        '${{ inputs.configuration }}' \
              --define               '${{ inputs.preprocessor-symbols }}' \
              --min-coverage-pct     '${{ inputs.min-coverage-pct }}' \
              --max-regression-pct   '${{ inputs.max-regression-pct }}' \
              --minver-tag-prefix    '${{ inputs.minver-tag-prefix }}' \
              --minver-prerelease-id '${{ inputs.minver-prerelease-id }}'

  # Build the project and cache artifacts for downstream test/benchmark jobs
  build:
    name: Build the source code
    needs:
      - validate-input
    strategy:
      # fail-fast: true
      matrix:
        runner-os: ${{ fromJSON(needs.validate-input.outputs.runners-os) }}
        build-project: ${{ fromJSON(needs.validate-input.outputs.build-projects) }}
    uses: vmelamed/vm2.DevOps/.github/workflows/_build.yaml@main
    with:
      build-project: ${{ matrix.build-project }}
      runner-os: ${{ matrix.runner-os }}
      dotnet-version: ${{ needs.validate-input.outputs.dotnet-version }}
      configuration: ${{ needs.validate-input.outputs.configuration }}
      preprocessor-symbols: ${{ needs.validate-input.outputs.preprocessor-symbols }}
      minver-tag-prefix: ${{ needs.validate-input.outputs.minver-tag-prefix }}
      minver-prerelease-id: ${{ needs.validate-input.outputs.minver-prerelease-id }}

  # Run unit tests with code coverage analysis
  test:
    name: Run unit and integration tests
    needs:
      - validate-input
      - build
    strategy:
      # fail-fast: true
      matrix:
        runner-os: ${{ fromJSON(needs.validate-input.outputs.runners-os) }}
    # __skip__ sentinel avoids empty-matrix expansion when no tests are requested
    if: >
      needs.validate-input.outputs.test-projects != '["__skip__"]' &&
      needs.validate-input.outputs.test-projects != '[""]'
    uses: vmelamed/vm2.DevOps/.github/workflows/_test.yaml@main
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      REPORTGENERATOR_LICENSE: ${{ secrets.REPORTGENERATOR_LICENSE }}
    permissions:
      contents: read
      pull-requests: write # Required to comment on PRs
      checks: write # Required to create GitHub Checks
    with:
      test-projects: ${{ needs.validate-input.outputs.test-projects }}
      runner-os: ${{ matrix.runner-os }}
      dotnet-version: ${{ needs.validate-input.outputs.dotnet-version }}
      configuration: ${{ needs.validate-input.outputs.configuration }}
      preprocessor-symbols: ${{ needs.validate-input.outputs.preprocessor-symbols }}
      min-coverage-pct: ${{ fromJSON(needs.validate-input.outputs.min-coverage-pct) }}
      minver-tag-prefix: ${{ needs.validate-input.outputs.minver-tag-prefix }}
      minver-prerelease-id: ${{ needs.validate-input.outputs.minver-prerelease-id }}

  # Run performance benchmarks and compare against baseline (if enabled and benchmark project specified)
  benchmarks:
    name: Run performance benchmarks
    needs:
      - validate-input
      - build
    strategy:
      # fail-fast: true
      matrix:
        runner-os: ${{ fromJSON(needs.validate-input.outputs.runners-os) }}
        benchmark-project: ${{ fromJSON(needs.validate-input.outputs.benchmark-projects) }}
    # __skip__ sentinel avoids empty-matrix expansion; still honor [skip bm] on pushes
    if: >
      needs.validate-input.outputs.benchmark-projects != '["__skip__"]' &&
      needs.validate-input.outputs.benchmark-projects != '[""]' &&
      (github.event_name != 'push' || !contains(github.event.head_commit.message, '[skip bm]'))
    uses: vmelamed/vm2.DevOps/.github/workflows/_benchmarks.yaml@main
    secrets:
      BENCHER_API_TOKEN: ${{ secrets.BENCHER_API_TOKEN }}
    permissions:
      contents: read
      pull-requests: write # Required to comment on PRs
      checks: write # Required to create GitHub Checks
    with:
      benchmark-project: ${{ matrix.benchmark-project }}
      runner-os: ${{ matrix.runner-os }}
      dotnet-version: ${{ needs.validate-input.outputs.dotnet-version }}
      configuration: ${{ needs.validate-input.outputs.configuration }}
      preprocessor-symbols: ${{ needs.validate-input.outputs.preprocessor-symbols }}
      minver-tag-prefix: ${{ needs.validate-input.outputs.minver-tag-prefix }}
      minver-prerelease-id: ${{ needs.validate-input.outputs.minver-prerelease-id }}
      max-regression-pct: ${{ fromJSON(needs.validate-input.outputs.max-regression-pct) }}
