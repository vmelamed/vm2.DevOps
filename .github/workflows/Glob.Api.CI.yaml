name: Glob.Api.CI - Build, Test, Benchmarks

on:
  push:
    branches:
      - "**" # trigger on push for all branches

  pull_request:
    branches:
      - "**" # trigger on PR for all branches

  workflow_dispatch:
    inputs:
      os:
        description: Select the OS(es) to run on. Must be a valid JSON array of strings.
        type: string
        default: '["ubuntu-latest"]'

      preprocessor-symbols:
        description: Define constants to pass to the compiler
        type: string
        default: ""

      cached-dependencies:
        description: Enable storing and retrieving NuGet dependencies to/from cache (default true)
        type: boolean
        default: true

      cached-artifacts:
        description: Enable storing and retrieving build artifacts to/from cache (default true)
        type: boolean
        default: true

      verbose:
        description: Enable verbose logging by the scripts for debugging purposes
        type: boolean
        default: false

env:
  # TODO: TO BE REMOVED! - this is only for debugging purposes
  ACTIONS_RUNNER_DEBUG: true
  ACTIONS_JOB_DEBUG: true
  ACTIONS_STEP_DEBUG: true

jobs:
  get-params:
    name: Prepare the default and passed in parameters
    if: >
      ${{
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip ci]')
      }}
    runs-on: "ubuntu-latest"  # it doesn't matter - here we're preparing the inputs to the next workload'
    outputs:
      # the following outputs are invariant to this workflow - no matter how we trigger the workflow these stay the same:
      build-projects:       ${{ steps.init-params.outputs.build-projects }}
      test-projects:        ${{ steps.init-params.outputs.test-projects }}
      benchmark-projects:   ${{ steps.init-params.outputs.benchmark-projects }}
      # the following outputs either have default values or are coming from manual dispatch:
      os:                   ${{ steps.init-params.outputs.os }}
      preprocessor-symbols: ${{ steps.init-params.outputs.preprocessor-symbols }}
      verbose:              ${{ steps.init-params.outputs.verbose }}
      cached-dependencies:  ${{ steps.init-params.outputs.cached-dependencies }}
      cached-artifacts:     ${{ steps.init-params.outputs.cached-artifacts }}
      # the following ouputs depend only on variables - policies set by the authorized:
      dotnet-version:       ${{ steps.init-params.outputs.dotnet-version }}
      configuration:        ${{ steps.init-params.outputs.configuration }}
      min-coverage-pct:     ${{ steps.init-params.outputs.min-coverage-pct }}
      max-regression-pct:   ${{ steps.init-params.outputs.max-regression-pct }}
      force-new-baseline:   ${{ steps.init-params.outputs.force-new-baseline }}
    steps:
      - name: Init parameters
        id: init-params
        shell: bash
        run: |
          # the following outputs are invariant to this workflow - no matter how we trigger the workflow these stay the same:
          build_projects=" \
            [ \
              \"vm2.DevOps.slnx\" \
            ]"  # build the whole solution at once
          test_projects=" \
            [ \
              \"./test/Glob.Api.FakeFileSystem.Tests/Glob.Api.FakeFileSystem.Tests.csproj\", \
              \"./test/Glob.Api.Tests/Glob.Api.Tests.csproj\" \
            ]"
          benchmark_projects=" \
            [ \
              \"./benchmarks/Glob.Api.Benchmarks/Glob.Api.Benchmarks.csproj\" \
            ]"

          # the following outputs either have default values or are coming from manual dispatch:
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Parse inputs from workflow_dispatch event
            os="${{ github.event.inputs.os }}"
            preprocessor_symbols="${{ github.event.inputs['preprocessor-symbols'] }}"
            cached_dependencies="${{ github.event.inputs['cached-dependencies'] }}"
            cached_artifacts="${{ github.event.inputs['cached-artifacts'] }}"
            verbose="${{ github.event.inputs.verbose }}"
          else
            # Set defaults for push and pull_request events
            os='["ubuntu-latest"]'
            preprocessor_symbols=""
            cached_dependencies="true"
            cached_artifacts="true"
            verbose="false"
          fi

          # the following ouputs depend only on variables - policies set by the authorized:
          dotnet_version=${{ vars.DOTNET_VERSION }}
          configuration=${{ vars.CONFIGURATION }}
          min_coverage_pct=${{ vars.MIN_COVERAGE_PCT }}
          max_regression_pct=${{ vars.MAX_REGRESSION_PCT }}
          force_new_baseline=${{ vars.FORCE_NEW_BASELINE }}

          {
            echo "build-projects       ${build_projects}"
            echo "test-projects        ${test_projects}"
            echo "benchmark-projects   ${benchmark_projects}"
            echo "os                   ${os}"
            echo "dotnet-version       ${dotnet_version}"
            echo "configuration        ${configuration}"
            echo "preprocessor-symbols ${preprocessor_symbols}"
            echo "min-coverage-pct     ${min_coverage_pct}"
            echo "max-regression-pct   ${max_regression_pct}"
            echo "force-new-baseline   ${force_new_baseline}"
            echo "verbose              ${verbose}"
          } >> $GITHUB_STEP_SUMMARY
          {
            echo "build-projects       ${build_projects}"
            echo "test-projects        ${test_projects}"
            echo "benchmark-projects   ${benchmark_projects}"
            echo "os                   ${os}"
            echo "dotnet-version       ${dotnet_version}"
            echo "configuration        ${configuration}"
            echo "preprocessor-symbols ${preprocessor_symbols}"
            echo "min-coverage-pct     ${min_coverage_pct}"
            echo "max-regression-pct   ${max_regression_pct}"
            echo "force-new-baseline   ${force_new_baseline}"
            echo "verbose              ${verbose}"
          }  >> "${GITHUB_OUTPUT}"

  call_ci:
    name: Call the CI Workflow
    needs:
      - get-params
    if: >
      ${{
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip ci]')
      }}
    # uses: ./.github/workflows/_ci.yaml
    # with:
    #   build-projects:       ${{ needs.get-params.outputs.build-projects       }}
    #   test-projects:        ${{ needs.get-params.outputs.test-projects        }}
    #   benchmark-projects:   ${{ needs.get-params.outputs.benchmark-projects   }}
    #   os:                   ${{ needs.get-params.outputs.os                   }}
    #   dotnet-version:       ${{ needs.get-params.outputs.dotnet-version       }}
    #   configuration:        ${{ needs.get-params.outputs.configuration        }}
    #   preprocessor-symbols: ${{ needs.get-params.outputs.preprocessor-symbols }}
    #   min-coverage-pct:     ${{ needs.get-params.outputs.min-coverage-pct     }}
    #   max-regression-pct:   ${{ needs.get-params.outputs.max-regression-pct   }}
    #   force-new-baseline:   ${{ needs.get-params.outputs.force-new-baseline   }}
    #   cached-dependencies:  ${{ needs.get-params.outputs.cached-dependencies  }}
    #   cached-artifacts:     ${{ needs.get-params.outputs.cached-artifacts     }}
    #   verbose:              ${{ needs.get-params.outputs.verbose              }}
    # TO BE REMOVED WHEN ACTUALLY RUNNING THE BUILD WORKFLOW:
    runs-on: ubuntu-latest  # it doesn't matter here
    steps:
      - name: Print
        shell: bash
        run: |+
          {
            echo "uses ./.github/workflows/_ci.yaml"
            echo "with"
            echo "  build-projects:       ${{ needs.get-params.outputs.build-projects       }}"
            echo "  test-projects:        ${{ needs.get-params.outputs.test-projects        }}"
            echo "  benchmark-projects:   ${{ needs.get-params.outputs.benchmark-projects   }}"
            echo "  os:                   ${{ needs.get-params.outputs.os                   }}"
            echo "  dotnet-version:       ${{ needs.get-params.outputs.dotnet-version       }}"
            echo "  configuration:        ${{ needs.get-params.outputs.configuration        }}"
            echo "  preprocessor-symbols: ${{ needs.get-params.outputs.preprocessor-symbols }}"
            echo "  min-coverage-pct:     ${{ needs.get-params.outputs.min-coverage-pct     }}"
            echo "  max-regression-pct:   ${{ needs.get-params.outputs.max-regression-pct   }}"
            echo "  force-new-baseline:   ${{ needs.get-params.outputs.force-new-baseline   }}"
            echo "  cached-dependencies:  ${{ needs.get-params.outputs.cached-dependencies  }}"
            echo "  cached-artifacts:     ${{ needs.get-params.outputs.cached-artifacts     }}"
            echo "  verbose:              ${{ needs.get-params.outputs.verbose              }}"
          } >> $GITHUB_STEP_SUMMARY
