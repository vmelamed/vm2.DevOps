name: _release (Reusable workflow)

on:
  workflow_call:
    inputs:
      dotnet-version:
        description: Version of .NET SDK to use (cannot be null or empty string, default 10.0.x)
        type: string
        default: 10.0.x

      package-projects:
        description: >-
          JSON array of project/solution paths to package and publish, e.g. '["src/Project1/Project1.csproj", "src/Project2/Project2.csproj"]'.
          If empty array, auto-detects root .sln or .csproj files.
        type: string
        default: '[""]'

      nuget-server:
        description: NuGet server to publish to (nuget or github)
        type: string
        default: "nuget"

      reason:
        description: Reason for manual release
        type: string
        required: true

      save-package-artifacts:
        description: Upload package(s) as workflow artifacts
        type: boolean
        default: false

    secrets:
      NUGET_API_GITHUB_KEY:
        description: >-
          Token for authentication to the GitHub NuGet server - must be for the GitHub Packages server.
          If GitHub Packages server is not used, this secret can be left empty.
        required: false

      NUGET_API_NUGET_KEY:
        description: >-
          Token for authentication to the nuget.org NuGet server - must be for the nuget.org server.
          If nuget.org server is not used, this secret can be left empty.
        required: false

      NUGET_API_KEY:
        description: >-
          Token for authentication to a custom NuGet server - must be for the selected nuget-server.
          Also used as the default token if nuget-server is 'nuget' or 'github'.
          If a custom NuGet server is not used, this secret can be left empty.
        required: false

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  NUGET_SERVER: ${{ inputs.nuget-server || 'nuget' }}
  ARTIFACTS_DIR: artifacts/pack

jobs:
  compute-version:
    name: Compute Release Version
    runs-on: ubuntu-latest
    outputs:
      package-projects: ${{ steps.version.outputs.package-projects }}
      nuget-server: ${{ steps.version.outputs.nuget-server }}
      minver-tag-prefix: ${{ steps.version.outputs.minver-tag-prefix }}
      release-version: ${{ steps.version.outputs.release-version }}
      release-tag: ${{ steps.version.outputs.release-tag }}
      reason: ${{ steps.version.outputs.reason }}
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Composite action Setup DevOps scripts (local)
        uses: ./.github/actions/scripts

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Validate and compute release version
        id: version
        shell: bash
        run: |+
          .github/actions/scripts/compute-release-version.sh \
              --package-projects '${{ inputs.package-projects }}' \
              --nuget-server '${{ inputs.nuget-server }}' \
              --minver-tag-prefix '${{ vars.MinVerTagPrefix || 'v' }}' \
              --reason '${{ inputs.reason }}'

  changelog:
    name: Update CHANGELOG
    runs-on: ubuntu-latest
    needs:
      - compute-version
    steps:
      - name: Checkout (full history on main)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Composite action Setup DevOps scripts (local)
        uses: ./.github/actions/scripts

      - name: Install git-cliff
        uses: taiki-e/install-action@v2
        with:
          tool: git-cliff

      - name: Update CHANGELOG for release
        shell: bash
        run: |
          .github/actions/scripts/update-changelog-release.sh \
              --release-tag "${{ needs.compute-version.outputs.release-tag }}" \
              --minver-tag-prefix "${{ needs.compute-version.outputs.minver-tag-prefix }}"

  tag-release:
    name: Create and Push Release Tag
    runs-on: ubuntu-latest
    needs:
      - compute-version
      - changelog
    steps:
      - name: Checkout (with changelog updates)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: main # Get latest main with changelog updates

      - name: Composite action Setup DevOps scripts (local)
        uses: ./.github/actions/scripts

      - name: Create and push release tag
        shell: bash
        run: |
          .github/actions/scripts/create-release-tag.sh \
              --release-tag "${{ needs.compute-version.outputs.release-tag }}" \
              --reason "${{ inputs.reason }}"

  release:
    name: Build and Publish Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - compute-version
      - tag-release
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJSON(needs.compute-version.outputs.package-projects) }}
    steps:
      - name: Checkout release tag (full history)
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.compute-version.outputs.release-tag }}
          fetch-tags: true
          fetch-depth: 0

      - name: Composite action Setup DevOps scripts (local)
        uses: ./.github/actions/scripts

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ inputs.dotnet-version || '10.0.x' }}
          cache: true
          cache-dependency-path: |+
            **/packages.lock.json
            **/*.csproj

      - name: Build, Package and Publish release to NuGet server
        shell: bash
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
          NUGET_API_GITHUB_KEY: ${{ secrets.NUGET_API_GITHUB_KEY }}
          NUGET_API_NUGET_KEY: ${{ secrets.NUGET_API_NUGET_KEY }}
        run: |+
          .github/actions/scripts/publish-packages.sh \
              --package-project "${{ matrix.project }}" \
              --nuget-server "${{ needs.compute-version.outputs.nuget-server }}" \
              --minver-tag-prefix "${{ needs.compute-version.outputs.minver-tag-prefix }}" \
              --version "${{ needs.compute-version.outputs.release-version }}" \
              --git-tag "${{ needs.compute-version.outputs.release-tag }}" \
              --reason "${{ needs.compute-version.outputs.reason }}" \
              --artifacts-saved "${{ inputs.save-package-artifacts }}" \
              --artifacts-dir "${{ env.ARTIFACTS_DIR }}"

      - name: Upload package artifact
        if: inputs.save-package-artifacts == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: nuget-packages-${{ needs.compute-version.outputs.release-tag }}-${{ hashFiles(matrix.project) }}
          path: artifacts/pack/*.nupkg
          if-no-files-found: ignore
          overwrite: true
