name: _release (Reusable workflow)

on:
  workflow_call:
    inputs:
      package-projects:
        description: JSON array of project/solution paths to package and publish, e.g. '["src/Project1/Project1.csproj", "src/Project2/Project2.csproj"]'. If empty array, auto-detects root .sln or .csproj files.
        type: string
        required: false
        default: '[""]'

      dotnet-version:
        description: Version of .NET SDK to use
        type: string
        default: 10.0.x

      force-publish:
        description: Force publish even if already tagged
        type: boolean
        default: false

      reason:
        description: Reason for manual pre-release
        type: string
        default: ""

      nuget-server:
        description: "NuGet server to publish to (nuget or github)"
        type: string
        default: "nuget"

      save_package_artifacts:
        description: Upload package(s) as workflow artifacts
        type: boolean
        default: false

    secrets:
      NUGET_API_KEY:
        description: "Token for authentication to the NuGet server - must match the selected nuget-server"
        required: true

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  FORCE_PUBLISH: ${{ inputs.force-publish }}
  SAVE_PACKAGE_ARTIFACTS: ${{ inputs.save_package_artifacts }}
  NUGET_SERVER: ${{ inputs.nuget-server || 'nuget' }}

jobs:
  release:
    name: Release Stable
    if: ${{ github.event_name == 'workflow_dispatch' || (startsWith(github.ref, 'refs/tags/v') && !contains(github.ref_name,'-')) }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJSON(inputs.package-projects) }}
    steps:
      - name: Validate the current tag
        shell: bash
        run: |+
          if [[ ! "$GITHUB_REF_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "The current tag $GITHUB_REF_NAME is not a valid semantic version for a stable release (e.g. v1.2.3 or v2.0.0)"
            exit 1
          fi

      - name: Checkout (full history)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ inputs.dotnet-version || '10.0.x' }}
          cache: true
          cache-dependency-path: |+
            **/packages.lock.json
            **/*.csproj

      - name: Restore
        shell: bash
        run: |+
          dotnet restore \
            ${{ matrix.project }} \
            --locked-mode

      - name: Pack (stable)
        shell: bash
        run: |+
          mkdir -p artifacts/pack
          dotnet pack \
            ${{ matrix.project }} \
            --configuration Release \
            --output artifacts/pack \
            --no-restore \
            "/p:PackageReleaseNotes=Prerelease: ${{ inputs.reason || 'release build' }}"
          ls -1 artifacts/pack

      - name: Publish stable to NuGet server
        env:
          RELEASE_TAG: ${{ github.ref_name }}
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        shell: bash
        run: |+
          if [ -z "${NUGET_API_KEY}" ]; then
            echo "NUGET_API_KEY not configured"; exit 1
          fi
          API_KEY="$NUGET_API_KEY"
          if [ "$NUGET_SERVER" = "github" ]; then
            SERVER_NAME="GitHub Packages"
            SERVER_URL="https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"
          else
            SERVER_NAME="NuGet.org"
            SERVER_URL="https://api.nuget.org/v3/index.json"
          fi

          dotnet nuget push artifacts/pack/*.nupkg \
            --api-key  "$NUGET_API_KEY" \
            --source "$SERVER_URL" \
            --skip-duplicate
          printf '## Packages %s pushed to %s:\n%s\n' "$RELEASE_TAG" "$SERVER_NAME" "$(ls -1 artifacts/pack/*.nupkg | sed 's/^/  - /')" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload package artifact
        if: env.SAVE_PACKAGE_ARTIFACTS == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: nuget-packages-${{ github.ref_name }}-${{ hashFiles(matrix.project) }}
          path: artifacts/pack/*.nupkg
          if-no-files-found: ignore
          overwrite: true

      - name: Summary
        env:
          ARTIFACTS_SAVED: ${{ env.SAVE_PACKAGE_ARTIFACTS == 'true' }}
        shell: bash
        run: |+
          {
              echo "## Release Summary"
              echo
              echo "- Tag: ${GITHUB_REF_NAME}"
              echo "- Stable release reason: ${REASON:-tag push}"
              if [ "$ARTIFACTS_SAVED" = "true" ]; then
                echo "- Artifacts:"
                ls -1 artifacts/pack | sed 's/^/  - /'
              fi
          } >> "$GITHUB_STEP_SUMMARY"
