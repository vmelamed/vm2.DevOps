name: _prerelease (Reusable workflow)

on:
  workflow_call:
    inputs:
      package-projects:
        description: >-
          JSON array of project/solution paths to package and publish, e.g. '["src/Project1/Project1.csproj", "src/Project2/Project2.csproj"]'.
          If empty array, dotnet CLI will auto-detect root .sln, .slnx, or .csproj files.
        type: string
        required: false
        default: '[""]'

      dotnet-version:
        description: Version of .NET SDK to use (cannot be null or empty string, default 10.0.x)
        type: string
        default: 10.0.x

      preprocessor-symbols:
        description: Preprocessor symbols to pass to the compiler
        type: string
        default: ""

      minver-tag-prefix:
        description: "Prefix for git tags to be recognized by MinVer (default 'v')"
        type: string
        default: "v"

      minver-prerelease-id:
        description: Prefix for the prerelease tag, e.g. 'preview.0', 'alpha', 'beta', 'rc', etc. (cannot be null or empty string, default 'preview.0')
        type: string
        default: "preview.0"

      reason:
        description: Reason for manual pre-release
        type: string
        default: ""

      nuget-server:
        description: "NuGet server to publish to (supported values for now: 'nuget' or 'github')"
        type: string
        default: nuget

      save-package-artifacts:
        description: Upload package(s) as workflow artifacts
        type: boolean
        default: false

    secrets:
      NUGET_API_GITHUB_KEY:
        description: >-
          Token for authentication to the GitHub NuGet server - must be for the GitHub Packages server.
          If GitHub Packages server is not used, this secret can be left empty.
        required: false

      NUGET_API_NUGET_KEY:
        description: >-
          Token for authentication to the nuget.org NuGet server - must be for the nuget.org server.
          If nuget.org server is not used, this secret can be left empty.
        required: false

      NUGET_API_KEY:
        description: >-
          Token for authentication to a custom NuGet server - must be for the selected nuget-server.
          Also used as the default token if nuget-server is 'nuget' or 'github'.
          If a custom NuGet server is not used, this secret can be left empty.
        required: false

concurrency:
  group: prerelease-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  VERBOSE: ${{ vars.VERBOSE }}

jobs:
  changelog:
    name: Update changelog
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          filter: tree:0

      # Clone only the scripts from vm2.DevOps, so that we can run the composite
      # action .github/actions/scripts/action.yaml for both local and external calls
      - name: Checkout vm2.DevOps repository scripts
        if: github.repository != 'vmelamed/vm2.DevOps'
        uses: actions/checkout@v6
        with:
          repository: vmelamed/vm2.DevOps
          path: vm2-devops
          persist-credentials: false
          sparse-checkout: |+
            scripts/bash/lib
            .github/actions/scripts
      - name: Add vm2.DevOps to PATH for work inside vm2.DevOps
        if: github.repository == 'vmelamed/vm2.DevOps'
        uses: ./.github/actions/scripts
      - name: Add vm2.DevOps to PATH for work outside vm2.DevOps
        if: github.repository != 'vmelamed/vm2.DevOps'
        uses: ./vm2-devops/.github/actions/scripts

      - name: Install git-cliff
        uses: taiki-e/install-action@v2
        with:
          tool: git-cliff

      - name: Update CHANGELOG for prerelease
        id: changelog_update
        shell: bash
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          source ${DEVOPS_LIB_DIR}/gh_core.sh

          if [ ! -s changelog/cliff.prerelease.toml ]; then
              error "Missing changelog/cliff.prerelease.toml; failing."
              exit 2
          fi

          prerelease_date=$(date +%Y-%m-%d)
          echo "prerelease-date=${prerelease_date}" >> $GITHUB_OUTPUT

          git-cliff -c changelog/cliff.prerelease.toml \
              --tag "Prerelease-$prerelease_date" \
              --unreleased \
              --prepend CHANGELOG.md

          if git diff --quiet -- CHANGELOG.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create PR for changelog update
        id: create_changelog_pr
        if: steps.changelog_update.outputs.changed == 'true'
        continue-on-error: true
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          add-paths: CHANGELOG.md
          commit-message: "chore: update changelog for Prerelease-${{ steps.changelog_update.outputs.prerelease-date }}"
          branch: chore/prerelease-changelog-${{ steps.changelog_update.outputs.prerelease-date }}
          delete-branch: true
          title: "chore: update changelog for Prerelease-${{ steps.changelog_update.outputs.prerelease-date }}"
          body: |
            Automated changelog update generated by the prerelease workflow.

            This change is created as a pull request to comply with branch protection / repository rules.

      - name: Log changelog update result
        if: always()
        env:
          CHANGELOG_CHANGED: ${{ steps.changelog_update.outputs.changed }}
          PR_CREATE_OUTCOME: ${{ steps.create_changelog_pr.outcome }}
        shell: bash
        run: |
          if [ "$CHANGELOG_CHANGED" != "true" ]; then
            echo "::warning::No changelog changes to commit."
          elif [ "$PR_CREATE_OUTCOME" == "success" ]; then
            echo "::notice::Changelog changes detected; a pull request was created/updated."
            echo "::warning::Review CHANGELOG.md before release."
          else
            echo "::warning::Changelog changed, but PR creation failed."
            echo "::warning::Enable repository setting 'Allow GitHub Actions to create and approve pull requests' or use a PAT-based bot token."
            {
              echo "## Changelog PR automation blocked"
              echo
              echo "The prerelease workflow updated CHANGELOG.md, but creating/updating a PR was blocked by repository Actions permissions."
              echo
              echo "To enable automatic changelog PRs:"
              echo "- Settings -> Actions -> General -> Workflow permissions"
              echo "- Enable: Allow GitHub Actions to create and approve pull requests"
              echo
              echo "Alternative: provide a dedicated PAT-based bot token for PR creation."
            } >> "$GITHUB_STEP_SUMMARY"
          fi

  package-and-publish:
    name: Publish Package (prerelease) to NuGet server
    needs:
      - changelog
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      packages: write
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJSON(inputs.package-projects) }}
    env:
      ARTIFACTS_DIR: artifacts/pack
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          filter: tree:0

      # Clone only the scripts from vm2.DevOps, so that we can run the composite
      # action .github/actions/scripts/action.yaml for both local and external calls
      - name: Checkout vm2.DevOps repository scripts
        if: github.repository != 'vmelamed/vm2.DevOps'
        uses: actions/checkout@v6
        with:
          repository: vmelamed/vm2.DevOps
          path: vm2-devops
          persist-credentials: false
          sparse-checkout: |+
            scripts/bash/lib
            .github/actions/scripts
      - name: Add vm2.DevOps to PATH for work inside vm2.DevOps
        if: github.repository == 'vmelamed/vm2.DevOps'
        uses: ./.github/actions/scripts
      - name: Add vm2.DevOps to PATH for work outside vm2.DevOps
        if: github.repository != 'vmelamed/vm2.DevOps'
        uses: ./vm2-devops/.github/actions/scripts

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ inputs.dotnet-version }}
          dotnet-quality: 'ga'
          cache: true
          cache-dependency-path: |
            **/packages.lock.json
            **/*.csproj

      # Authenticate with GitHub Packages for NuGet restore
      - name: Authenticate with GitHub Packages
        shell: bash
        run: |
          dotnet nuget update source github.vm2 \
            --username ${{ github.actor }} \
            --password ${{ secrets.GITHUB_TOKEN }} \
            --store-password-in-clear-text

      - name: Publish package (prerelease) to NuGet server
        shell: bash
        id: publish
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
          NUGET_API_GITHUB_KEY: ${{ secrets.NUGET_API_GITHUB_KEY }}
          NUGET_API_NUGET_KEY: ${{ secrets.NUGET_API_NUGET_KEY }}
        run: |
          publish-package.sh \
              --package-project "${{ matrix.project }}" \
              --define "${{ inputs.preprocessor-symbols }}" \
              --minver-tag-prefix "${{ inputs.minver-tag-prefix }}" \
              --minver-prerelease-id "${{ inputs.minver-prerelease-id }}" \
              --reason "${{ inputs.reason }}" \
              --nuget-server "${{ inputs.nuget-server }}" \
              --artifacts-saved "${{ inputs.save-package-artifacts }}" \
              --artifacts-dir "${{ env.ARTIFACTS_DIR }}"

      - name: Upload package artifact
        if: inputs.save-package-artifacts == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: nuget-packages-${{ steps.publish.outputs.prerelease-tag }}-${{ hashFiles(matrix.project) }}
          path: ${{ env.ARTIFACTS_DIR }}/*.nupkg
          if-no-files-found: ignore
          overwrite: true
