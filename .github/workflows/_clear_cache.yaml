name: _clear_cache (Reusable workflow)

on:
  workflow_call:
    inputs:

      reason:
        description: 'Reason for clearing cache'
        type: string
        default: 'Emergency cache cleanup'

      cache-pattern:
        description: 'Cache key pattern to delete (build-artifacts-*, nuget-*, <other-patterns>) (default: nuget-*)'
        required: false
        type: string
        default: 'nuget-'

permissions:
  actions: write
  contents: read

jobs:
  clear-cache:
    name: Clear NuGet Cache
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Delete matching caches
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CACHE_PATTERN: ${{ inputs.cache-pattern }}
          REASON: ${{ inputs.reason }}
        run: |
          echo "🗑️ Clearing caches matching pattern: $CACHE_PATTERN"
          echo "📝 Reason: $REASON"
          echo ""

          # List all caches
          echo "📋 Current caches:"
          gh cache list --limit 100 || true
          echo ""

          # Delete matching caches
          echo ""
          echo "🗑️ Deleting caches matching '${CACHE_PATTERN}*'..."

          gh cache list --limit 1000 \
            | grep "^${CACHE_PATTERN}" \
            | awk '{print $1}' \
            | while read -r cache_id; do
                echo "  Deleting cache: ${cache_id}"
                gh cache delete "${cache_id}" --confirm 2>/dev/null || true
              done

          echo ""
          echo "✅ Cache cleanup complete"
          echo "📋 Remaining caches:"
          gh cache list --limit 100 || true

          # Output to step summary
          {
            echo "## 🗑️ Cache Cleanup Complete"
            echo ""
            echo "**Pattern:** \`${CACHE_PATTERN}*\`"
            echo ""
            echo "**Reason:** ${REASON}"
            echo ""
            echo "### Remaining Caches"
            echo ""
            gh cache list --limit 20 || echo "No caches remaining"
          } >> "$GITHUB_STEP_SUMMARY"
