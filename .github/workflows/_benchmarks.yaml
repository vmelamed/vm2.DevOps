name: _benchmarks-bencher (Reusable workflow with Bencher.dev integration)

on:
  workflow_call:
    inputs:
      os:
        description: Runner OS (cannot be null or empty string, default ubuntu-latest)
        type: string
        default: ubuntu-latest

      dotnet-version:
        description: Version of .NET SDK to use (cannot be null or empty string, default 10.0.x)
        type: string
        default: 10.0.x

      configuration:
        description: The type of build to produce, e.g. Release vs Debug (cannot be null or empty string, default Release)
        type: string
        default: Release

      preprocessor-symbols:
        description: Preprocessor symbols to pass to the compiler
        type: string
        default: "_"

      benchmark-project:
        description: Path to the benchmark project to run benchmarks against (cannot be null or empty string)
        type: string
        required: true

      max-regression-pct:
        description: Maximum acceptable performance regression percentage (used for Bencher threshold)
        type: number
        default: 20 # percent

      cached-dependencies:
        description: Enable caching of NuGet dependencies (default true)
        type: boolean
        default: true

      cached-artifacts:
        description: Enable caching of build artifacts (default true)
        type: boolean
        default: true

      verbose:
        description: Whether to enable verbose logging for debugging scripts
        type: boolean
        default: false

    secrets:
      BENCHER_API_TOKEN:
        description: Bencher.dev API token for authentication
        required: true

permissions:
  contents: read
  pull-requests: write # Required for Bencher to comment on PRs
  checks: write # Required for Bencher to create GitHub Checks

env:
  ARTIFACTS_DIR: ${{ github.workspace }}/BmArtifacts
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  benchmarks:
    name: Benchmarks (${{ inputs.os }})
    runs-on: ${{ inputs.os }}
    steps:
      # Clone the repository with full Git history
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # Setup DevOps scripts from vm2.DevOps
      - name: Checkout DevOps repository
        uses: actions/checkout@v6
        with:
          repository: vmelamed/vm2.DevOps
          path: .devops
          sparse-checkout: |
            .github/actions/scripts

      - name: Setup DevOps scripts
        uses: ./.devops/.github/actions/scripts

      # Generate a weekly cache key to automatically rotate NuGet cache
      - name: Get cache timestamp (weekly rotation)
        if: inputs.cached-dependencies == true
        id: cache-timestamp
        shell: bash
        run: |
          CACHE_WEEK=$(date +%Y-W%V)
          echo "week=$CACHE_WEEK" >> $GITHUB_OUTPUT
          echo "Cache rotation key: $CACHE_WEEK"

      # Install .NET SDK with built-in NuGet package caching
      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ inputs.dotnet-version }}
          cache: ${{ inputs.cached-dependencies }}
          cache-dependency-path: |
            **/packages.lock.json
            **/*.csproj

      # Additional explicit cache layer with time-based rotation
      - name: Cache NuGet packages (weekly rotation)
        if: inputs.cached-dependencies == true
        uses: actions/cache@v5
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ steps.cache-timestamp.outputs.week }}-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            nuget-${{ runner.os }}-${{ steps.cache-timestamp.outputs.week }}-
            nuget-${{ runner.os }}-

      # Retrieve compiled binaries from the build job
      - name: Restore build artifacts from cache
        if: inputs.cached-artifacts == true
        uses: actions/cache/restore@v5
        with:
          key: build-artifacts-${{ runner.os }}-${{ github.sha }}-${{ inputs.configuration }}
          fail-on-cache-miss: true
          path: |
            **/bin/${{ inputs.configuration }}
            **/obj

      # Run benchmarks using BenchmarkDotNet and export JSON results
      - name: Run BenchmarkDotNet benchmarks
        id: run-benchmarks
        shell: bash
        env:
          CONFIGURATION: ${{ inputs.configuration }}
          PREPROCESSOR_SYMBOLS: ${{ inputs.preprocessor-symbols }}
          VERBOSE: ${{ inputs.verbose }}
        run: |
          run-benchmarks.sh ${{ inputs.benchmark-project }} \
              --configuration "${{ inputs.configuration }}" \
              --artifacts "${{ env.ARTIFACTS_DIR }}" \
              ${{ inputs.cached-dependencies && '--cached-dependencies' || '' }} \
              ${{ inputs.cached-artifacts    && '--cached-artifacts'    || '' }}

      # Install Bencher CLI
      - name: Install Bencher CLI
        uses: bencherdev/bencher@main

      # Track benchmarks with Bencher using CLI
      - name: Track benchmarks with Bencher
        shell: bash
        env:
          BENCHER_BRANCH: ${{ github.ref_name }}
          BENCHER_API_TOKEN: ${{ secrets.BENCHER_API_TOKEN }}
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          # Calculate threshold as a decimal (e.g., 10% -> 0.90)
          LOWER_THRESHOLD=$(echo "scale=4; ${{ inputs.max-regression-pct }} / 100" | bc)
          UPPER_THRESHOLD=$(echo "scale=4; 1 - ${{ inputs.max-regression-pct }} / 100" | bc)

          # Build bencher run command
          BENCHER_CMD="bencher run \
            --branch \"${{ github.ref_name }}\" \
            --testbed "${{ inputs.os }}" \
            --adapter c_sharp_dot_net \
            --err \
            --ci-on-the-fly \
            --github-actions \"$GITHUB_TOKEN\" \
            --iter 1 \
            --fold median"
            \
            --threshold-measure latency \
            --threshold-test t_test \
            --threshold-max-sample-size 64 \
            --threshold-lower-boundary _ \
            --threshold-upper-boundary $UPPER_THRESHOLD \
            \
            --threshold-measure throughput \
            --threshold-test t_test \
            --threshold-max-sample-size 64 \
            --threshold-lower-boundary $LOWER_THRESHOLD \
            --threshold-upper-boundary _ \
            \
            # --thresholds-reset

          # Add all benchmark result files
          for file in ${{ steps.run-benchmarks.outputs.results-dir }}/*-report.json; do
            if [[ -f "$file" ]]; then
              BENCHER_CMD="$BENCHER_CMD --file \"$file\""
            fi
          done

          # Echo the command for debugging (without token)
          echo "Running: bencher run --branch ${{ github.ref_name }} --testbed ${{ inputs.os }} ..."
          echo "Threshold: Â±${{ inputs.max-regression-pct }}% ($THRESHOLD)"
          echo "Files: ${{ steps.run-benchmarks.outputs.results-dir }}/*-report.json"

          # Execute the command with token
          BENCHER_CMD="$BENCHER_CMD --token $BENCHER_API_TOKEN"
          eval $BENCHER_CMD

      # Upload benchmark results as workflow artifacts for manual inspection
      - name: Upload benchmark results artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-results-${{ inputs.os }}
          path: ${{ env.ARTIFACTS_DIR }}
          if-no-files-found: warn
          overwrite: true

      # Add summary to job
      - name: Add Bencher results to summary
        if: always()
        shell: bash
        run: |
          # Compute Bencher project slug from repository name
          # Example: vmelamed/vm2.DevOps -> vm2-devops
          REPO_NAME="${{ github.repository }}"
          BENCHER_SLUG=$(echo "${REPO_NAME#*/}" | tr '[:upper:]' '[:lower:]' | tr '.' '-')

          {
            echo "### ðŸ“Š Benchmark Results"
            echo ""
            echo "Project: **${{ github.repository }}**"
            echo "Branch: **${{ github.ref_name }}**"
            echo "Testbed: **${{ inputs.os }}**"
            echo "Threshold: **Â±${{ inputs.max-regression-pct }}%**"
            echo ""
            echo "ðŸŒ [View detailed results on Bencher](https://bencher.dev/console/projects/${BENCHER_SLUG})"
          } >> $GITHUB_STEP_SUMMARY
